<head>
  <style> body { margin: 0; } </style>
  <script src="libraries/3d-force-graph.js"></script>
  <script src="libraries/index.min.js"></script>
  <script src="libraries/three.js"></script>
  <script src="libraries/three-spritetext.min.js"></script>
  <script src="libraries/dat.gui.js"></script>
  <script src="libraries/d3.v3.min.js" charset="utf-8"></script>
  <script src="libraries/rainbowvis.js"></script>
  <script src="https://github.com/mrdoob/three.js/blob/dev/examples/jsm/deprecated/Geometry.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweakpane@3.0.2/dist/tweakpane.min.js"></script>
  <script src="js/fstdropdown.js"></script>
  <script src="js/networks.js"></script>
  <link rel="stylesheet" href="css/fstdropdown.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style type="text/css">
    #gui {
    position: absolute;
    left: 2px;   /* position inside relatively positioned parent */
    top: 140px;
    z-index: 10;   /* adjust as needed */
    }
    #tp {
    position: absolute;
    left: 2px;   /* position inside relatively positioned parent */
    top: 140px;
    z-index: 10;   /* adjust as needed */
    }

    #logo{
      position: absolute;
      margin-top: 10px;
      z-index:2;
    }
  
    .button {
  border: none;
  color: white;
  padding: 16px 30px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  transition-duration: 0.4s;
  cursor: pointer;
  position: absolute;
  left: 2px;   /* position inside relatively positioned parent */
  top: 340px;
  z-index: 10; 
}

.button1 {
  background-color: rgb(47,49,55); 
  color: rgb(167, 167, 167); 
  border: 0px solid #000000;
}

.button2 {
  border: none;
  padding: 16px 45px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  transition-duration: 0.4s;
  cursor: pointer;
  position: absolute;
  left: 140px;   /* position inside relatively positioned parent */
  top: 340px;
  z-index: 10; 
}



.button1:hover {
  background-color: #000000;
  color: white;
}

.p1 {
  font-family: Helvetica, sans-serif;
  position: absolute;
  font-size: 14px;
  left: 8px;   /* position inside relatively positioned parent */
  top: 267px;
  z-index: 10; 
}


#guiplace{
  font-size: 55px;
  position: absolute;
  left: 2px;   /* position inside relatively positioned parent */
  top: 210px;
  z-index: 10; 
  width: 270px;
}

body {
  font-family: 'Lato', sans-serif;
}


  </style>
</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" id="logo" width="170" height="40" viewBox="0 0 230 54">
    <rect id="Rectangle_1488" data-name="Rectangle 1488" width="230" height="54"/>
    <text id="PREDICTNet" transform="translate(113 37)" fill="#fff" font-size="30" font-family="Helvetica-Bold, Helvetica" font-weight="700" letter-spacing="0.1em"><tspan x="-96.586" y="0">PREDICTNet</tspan></text>
  </svg>

  <p class="p1">Node Query</p>
  <p>
    <select class='fstdropdown-select' id="nodequery" onchange="updateSearch()">
        <option value="">--</option>
    </select>
</p>
  <button class="button button1" onclick="screenshot()">SnapShot</button>

  <button class="button2 button1" onclick="queryReset()">Reset</button>


  <div id="guiplace"> </div>

  <div id="3d-graph"></div>

<script>

function openNav() {
  document.getElementById("myNav").style.width = "100%";
}

function closeNav() {
  document.getElementById("myNav").style.width = "0%";
}
//////////////// DATA CREATION ////////////////

    /// QUERY BOX FUNCTIONS ///
  function removeOptions(selectElement) {
   var i, L = selectElement.options.length - 1;
   for(i = L; i >= 0; i--) {
      selectElement.remove(i);
   }
   selectElement.fstdropdown.rebind()
}

function addOptions(addText, selectElement)
    {
        // Create an Option object       
        var opt = document.createElement("option");        

        // Assign text and value to Option object
        opt.text = addText;
        opt.value = addText;

        // Add an Option object to Drop Down List Box
        selectElement.options.add(opt);
    }

    //////////////// JSON FILE ////////////////
    var finalDataObj = Network_CD_time_A_TH_network
    var nodesList = Network_CD_time_A_TH_nodes
    //////////////// GRAPH CREATION ////////////////
     var elem = document.getElementById('3d-graph');
     var Graph = ForceGraph3D({rendererConfig:{preserveDrawingBuffer   : true}})
        .backgroundColor("#ffffff")
      (elem)
        .graphData(finalDataObj)
        .nodeThreeObject(node => CreateSource(node))   // KINASES
        .onNodeDragEnd(node => {
          node.fx = node.x;
          node.fy = node.y;
          node.fz = node.z; })
        .linkWidth(0.5)
        .linkColor(link => (link.edge_attr_1 == null)
          ? "#808080"
          : "#808080")
        
        .linkOpacity(0.5)
        .onNodeClick(node => {
          // Aim at node from outside it
          const distance = 40;
          const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
          Graph.cameraPosition(
            { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, // new position
            node, // lookAt ({ x, y, z })
            3000  // ms transition duration
          );
        });

        nodesList = nodesList.sort()
        var x = document.getElementById("nodequery");
        var nodeindexes = 0
        for(nodeindexes = 0; nodeindexes<nodesList.length;nodeindexes++){
          var optext = nodesList[nodeindexes]
          addOptions(optext,x)
        }
        
        //////////////// XXXXXX ////////////////
          
        function CreateSource(node)
        {
          var node_size
          if (node["source_attr_2"] == null){ // SourceNodeSize
            node_size = 1
          }
          else{
            var node_size = node["source_attr_2"] + 0.5
          }
          var mesh = (new THREE.Mesh(    
          new THREE.SphereGeometry(node_size*8,25,25),
          new THREE.MeshLambertMaterial({
            transparent: false,
            depthWrite: false,
            opacity: 1 //changed 0.8 to 1 
          })
        ))

        const sprite = new SpriteText(node.id);
        sprite.color = 'rgb(0,0,0)';
        sprite.textHeight = 5;
        //sprite.position.y = 15;
        mesh.add(sprite);
        

        var node_color
          if (node['source_attr_1'] == null){ // SourceNodeColor
            node_color = 0.5
          }
          else{
            var node_color = node['source_attr_1']
          }

        mesh.material.color.setHex(colors_general(node_color, false, 'ffffb3', 'yellow', 'orange', '#ee9a00', '#ff8c00'));
        return mesh
        }

        function CountPartitions(data)
        {
          var num_sites_dict = {}
          for (var node in data['nodes'])
          {
            if (data['nodes'][node]['group'] == '2')
             {
              num_sites = Object.keys(data['nodes'][node]['target_attr_1']).length
              var id = data['nodes'][node]['id']
              num_sites_dict[id] = num_sites
             }
          }
          return num_sites_dict
        }

        function CreateTarget(node)
        {
          var node_size
          if (node["target_attr_2"] == null){ // TargetNodeSize
            node_size = 1
          }
          else{
            var node_size = node["target_attr_2"] + 0.5
          }

          var num_sites_dict = CountPartitions(finalDataObj)
          if (num_sites_dict[node['id']] > 1) { // partitions
            verticalPartitions = num_sites_dict[node['id']]
          }
          else // no partitions
            verticalPartitions = 1
          
          radialPartitions = 25
          var mesh = new THREE.Mesh(
          new THREE.CylinderGeometry(node_size*8, node_size*8, node_size*8*verticalPartitions, radialPartitions, verticalPartitions),
          new THREE.MeshLambertMaterial({
            transparent: false,
            depthWrite: false,
            opacity: 1,
            wireframe: false,
            emissive: "#181818",
            vertexColors: THREE.FaceColors,
          }));

          if (!(verticalPartitions == 1))
          {
            for (var i = 0; i < radialPartitions*2*(verticalPartitions); i+=(verticalPartitions*2))
            {
                  j = 0
                  for (var position in node['target_attr_1']) {
                    target_attr_1 = Object.values(node['target_attr_1'][position])
                    mesh.geometry.faces[i+(j*2)].color.setHex(colors_target(target_attr_1)); 
                    mesh.geometry.faces[i+(j*2)+1].color.setHex(colors_target(target_attr_1));
                    var x = 0
                    for(x = i+(j*2)+2;x<i+(j*2)+27;x++){
                      mesh.geometry.faces[x].color.setHex("0x949494");                  
                    }
                    for(x = i+(j*2)+27;x<i+(j*2)+52;x++){
                      mesh.geometry.faces[x].color.setHex("0xcccccc");                  
                    }
  
                    j = j + 1
                    }
            }
          }
          else
          {
            // TargetNodeColor does not exist 
            if (Object.values(node['target_attr_1'][0])[0] == null)  { 
              target_attr_1 = "null"
            }
            else  { // TargetNodeColor exists  
              target_attr_1 = Object.values(node['target_attr_1'][0])
            }
            var face = 0
            for(face = 0; face<50;face++){
              mesh.geometry.faces[face].color.setHex(colors_target(target_attr_1));
            }
            face = 0
            for(face = 50; face<75;face++){
              mesh.geometry.faces[face].color.setHex("0x949494");
            }
            for(face = 75; face<100;face++){
              mesh.geometry.faces[face].color.setHex("0xcccccc");
            }
            //mesh.geometry.faces[55].color.setHex("0xcccccc");   
            //mesh.material.color.setHex(colors_target(target_attr_1));

          }

        if(PARAMS.Labels)
        {
          const sprite = new SpriteText(node.id);
          sprite.color = 'rgb(0,0,0)';
          sprite.textHeight = 5;
          //sprite.position.y = 15;
          mesh.add(sprite);
        }
          return mesh
          }

        function colors_target (l2fc_value) {
          // https://github.com/anomal/RainbowVis-JS look at example.html for usage
          // https://stackoverflow.com/questions/3080421/javascript-color-gradient

            var threshold_max = PARAMS.MaxFold // 1
            var threshold_min = PARAMS.MinFold // -1
            var rainbow = new Rainbow(); 
            rainbow.setNumberRange(-3, 3);
            rainbow.setSpectrum('2600e6', '2A00FF', '5533FF', '7F66FF', 'AA99FF', 'D4CCFF', 'cccccc', 'FFCCDD', 'FF99BB', 'FF6699', 'FF3377', 'FF0055', 'CC0044')

            if (l2fc_value >= threshold_min && l2fc_value <= threshold_max || l2fc_value=="null") {
              return "0xcccccc"
            }
            if (l2fc_value < threshold_min) {
              var hexColour = rainbow.colourAt(l2fc_value-threshold_min);
              var stringColor = '0x' + hexColour
              return stringColor
            } 
            else {
              var hexColour = rainbow.colourAt(l2fc_value-threshold_max);
              var stringColor = '0x' + hexColour
              return stringColor
            } 
        }

        function colors_general (l2fc_value, isHexFlag, color1, color2, color3, color4, color5) {
            var rainbow = new Rainbow(); 
            thisColor1 = String(color1)
            thisColor2 = String(color2)
            thisColor3 = String(color3)
            thisColor4 = String(color4)
            thisColor5 = String(color5)
            rainbow.setNumberRange(0, 1);
            rainbow.setSpectrum(thisColor1, thisColor2, thisColor3, thisColor4, thisColor5)
            var hexColour = rainbow.colourAt(l2fc_value);
            var stringColor = '0x' + hexColour
            if (isHexFlag){
              var modcolor =  parseInt(hexColour, 16 )
              return modcolor
            }
            else 
              return stringColor
          
        }

        function screenshot(){
        var ImageBase64 = Graph.renderer().domElement.toDataURL("image/png");
        var a = document.createElement("a"); //Create <a>
        a.href = ImageBase64; //Image Base64 Goes here
        a.download = "image.png"; //File name Here
        a.click(); //Downloaded file
        }

    const CAMERA_DISTANCE2NODES_FACTOR = 170;

  
file_names = ["Network_CD_time_A_TH_0.01","Network_CD_time_B_TH_0.01","Network_CD_time_C_TH_0.01","Network_CD_time_D_TH_0.01","Network_HC_time_A_TH_0.01","Network_HC_time_B_TH_0.01","Network_HC_time_C_TH_0.01","Network_HC_time_D_TH_0.01","Network_UC_time_A_TH_0.01","Network_UC_time_B_TH_0.01","Network_UC_time_C_TH_0.01","Network_UC_time_D_TH_0.01"]
const fnames = {};
 for (const key of file_names) {
  fnames[key] = key;
 }

 const PARAMS = {
  Networks: "Network_CD_time_A_TH_0.01",
  Background : "#ffffff"
};

const pane = new Tweakpane.Pane({
  container: document.getElementById('guiplace'),
});

pane.addInput(PARAMS, 'Networks',{options: fnames}).on('change', (ev) => {
  changeState();
  });

pane.addInput(PARAMS, 'Background').on('change', (ev) => {
  updateBackground();
  });

//////////////////////////////////////////////
    function updateSearch() {
      var x = document.getElementById("nodequery");
      if(x.value == ""){
        var nodenum = Graph.graphData().nodes.length
        Graph.cameraPosition({x:0,y:0,z:Math.cbrt(nodenum) * CAMERA_DISTANCE2NODES_FACTOR},{x:0,y:0,z:0},2000)
      }

      Graph.nodeThreeObjectExtend(node => {
        var selectedNode = x.value //change
        if (selectedNode == node.id) {
              {   const distance = 100;
                  const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
                  Graph.cameraPosition(
                      { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, // new position
                      node, // lookAt ({ x, y, z })
                      3000  // ms transition duration
                      );
              }
          }
      })
      }
        
    function updateBackground() {
      Graph.backgroundColor(PARAMS.Background)

    }

    function toggleLabels() {
      Graph.nodeThreeObject(node =>  (node.group == '2')
      
          ? CreateTarget(node) // SUBSTRATES
          : CreateSource(node)) // KINASES

    }


    function changeState(){
    var new_file_name = PARAMS.Networks
    if(new_file_name == "Network_CD_time_A_TH_0.01"){
      finalDataObj = Network_CD_time_A_TH_network
      nodesList = Network_CD_time_A_TH_nodes
    }
    else if (new_file_name == "Network_CD_time_B_TH_0.01"){
      finalDataObj = Network_CD_time_B_TH_network
      nodesList = Network_CD_time_B_TH_nodes
    }
    else if (new_file_name == "Network_CD_time_C_TH_0.01"){
      finalDataObj = Network_CD_time_C_TH_network
      nodesList = Network_CD_time_C_TH_nodes
    }
    else if (new_file_name == "Network_CD_time_D_TH_0.01"){
      finalDataObj = Network_CD_time_D_TH_network
      nodesList = Network_CD_time_D_TH_nodes
    }
    else if (new_file_name == "Network_HC_time_A_TH_0.01"){
      finalDataObj = Network_HC_time_A_TH_network
      nodesList = Network_HC_time_A_TH_nodes
    }
    else if (new_file_name == "Network_HC_time_B_TH_0.01"){
      finalDataObj = Network_HC_time_B_TH_network
      nodesList = Network_HC_time_B_TH_nodes
    }
    else if (new_file_name == "Network_HC_time_C_TH_0.01"){
      finalDataObj = Network_HC_time_C_TH_network
      nodesList = Network_HC_time_C_TH_nodes
    }
    else if (new_file_name == "Network_HC_time_D_TH_0.01"){
      finalDataObj = Network_HC_time_D_TH_network
      nodesList = Network_HC_time_D_TH_nodes
    }
    else if (new_file_name == "Network_UC_time_A_TH_0.01"){
      finalDataObj = Network_UC_time_A_TH_network
      nodesList = Network_UC_time_A_TH_nodes
    }
    else if (new_file_name == "Network_UC_time_B_TH_0.01"){
      finalDataObj = Network_UC_time_B_TH_network
      nodesList = Network_UC_time_B_TH_nodes
    }
    else if (new_file_name == "Network_UC_time_C_TH_0.01"){
      finalDataObj = Network_UC_time_C_TH_network
      nodesList = Network_UC_time_C_TH_nodes
    }
    else if (new_file_name == "Network_UC_time_D_TH_0.01"){
      finalDataObj = Network_UC_time_D_TH_network
      nodesList = Network_UC_time_D_TH_nodes
    }
    /////////////// JSON FILE ////////////////
       Graph = ForceGraph3D({rendererConfig:{preserveDrawingBuffer: true}})
       .backgroundColor("#ffffff")
      (elem)
        .graphData(finalDataObj)
        .nodeThreeObject(node => CreateSource(node))   // KINASES
        .onNodeDragEnd(node => {
          node.fx = node.x;
          node.fy = node.y;
          node.fz = node.z; })
        .linkWidth(0.5)
        .linkColor(link => (link.edge_attr_1 == null)
          ? "#808080"
          : "#808080")
        
        .linkOpacity(0.5)
        .onNodeClick(node => {
          // Aim at node from outside it
          const distance = 40;
          const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
          Graph.cameraPosition(
            { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, // new position
            node, // lookAt ({ x, y, z })
            3000  // ms transition duration
          );
        });

        var x = document.getElementById("nodequery");
        removeOptions(x)

        var option = document.createElement("option");
        option.text = "--";
        option.value = ""
        x.add(option);
        nodesList = nodesList.sort()
        var nodeindexes = 0
        for(nodeindexes = 0; nodeindexes<nodesList.length;nodeindexes++){
          var optext = nodesList[nodeindexes]
          addOptions(optext,x)
          x.fstdropdown.rebind()
        }
        //////////////////////////////////////////////////////////////////////////
    }


    function queryReset(){
      document.getElementById("nodequery").selectedIndex = 0;
      document.getElementById("nodequery").fstdropdown.rebind()
      var nodenum = Graph.graphData().nodes.length
      Graph.cameraPosition({x:0,y:0,z:Math.cbrt(nodenum) * CAMERA_DISTANCE2NODES_FACTOR},{x:0,y:0,z:0},2000)

    }

  </script>
</body>